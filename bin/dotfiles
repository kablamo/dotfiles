#!/usr/bin/env perl

use strict;
use warnings;

use Path::Class qw/file dir/;
use File::Copy qw/move copy/;

my $home_dir   = dir('/home/eric');
my $links_dir  = $home_dir->subdir('code/dotfiles/links');
my $backup_dir = dir('/tmp/dotfiles-backup');

# remove dotfiles in $home_dir which are dead links
while (my $file = $home_dir->next) {
    next unless $file->basename =~ /^\./;
    next if -e $file;
    print "unlink $file\n" if -l $file;
    unlink $file       if -l $file;
}

# create links in $home_dir to $links_dir
while (my $file = $links_dir->next) {
    my $basename = $file->basename;
    next if $basename eq $links_dir->basename;
    next if $basename =~ /^\.\.$/;

    my $link = $home_dir->file($basename);
    next if -l $link;

    if (-e $link) {
        $backup_dir->mkpath;
        my $backup = $backup_dir->file($basename);

        if (! -o $link) {
            print "Cannot backup $basename to $backup:  Permission denied.\n";
            next;
        }

        print "backing up $basename to $backup\n";
        move($link, $backup);
    }

    my $ln = "ln -s '$file' '$link'";
    print $ln, "\n";
    `$ln`;
    # TODO: check for errors
}

